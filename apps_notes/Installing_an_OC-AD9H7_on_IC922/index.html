<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>OC-AD9H7 installation in IC922 - OC-Accel Doc</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
        <link href="../../extra.css" rel="stylesheet">

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">OC-Accel Doc</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">About <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../.." class="dropdown-item">Overview</a>
</li>
                                    
<li>
    <a href="../../repository/" class="dropdown-item">About the repository</a>
</li>
                                    
<li>
    <a href="../../system_firmware_setup/" class="dropdown-item">System Firmware Setup</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">User Guide <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../user-guide/0-steps/" class="dropdown-item">(0) Steps in a glance</a>
</li>
                                    
<li>
    <a href="../../user-guide/1-prepare-env/" class="dropdown-item">(1) Prepare environment</a>
</li>
                                    
<li>
    <a href="../../user-guide/2-run-helloworld/" class="dropdown-item">(2) Run helloworld</a>
</li>
                                    
<li>
    <a href="../../user-guide/3-new-action/" class="dropdown-item">(3) Create a new action</a>
</li>
                                    
<li>
    <a href="../../user-guide/4-hdl-design/" class="dropdown-item">(4) Verilog/VHDL design</a>
</li>
                                    
<li>
    <a href="../../user-guide/5-hls-design/" class="dropdown-item">(5) HLS C++ design</a>
</li>
                                    
<li>
    <a href="../../user-guide/6-co-simulation/" class="dropdown-item">(6) Co-Simulation</a>
</li>
                                    
<li>
    <a href="../../user-guide/7-build-image/" class="dropdown-item">(7) Build image</a>
</li>
                                    
<li>
    <a href="../../user-guide/8-deploy/" class="dropdown-item">(8) Deploy on Power Server</a>
</li>
                                    
<li>
    <a href="../../user-guide/9-migrate/" class="dropdown-item">(9) Migrate from SNAP1/2</a>
</li>
                                    
<li>
    <a href="../../user-guide/10-tips/" class="dropdown-item">(10) Tips</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Examples <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../actions-doc/hdl_example/" class="dropdown-item">hdl_example</a>
</li>
                                    
<li>
    <a href="../../actions-doc/hdl_single_engine/" class="dropdown-item">hdl_single_engine</a>
</li>
                                    
<li>
    <a href="../../actions-doc/hls_helloworld_512/" class="dropdown-item">hls_helloworld_512</a>
</li>
                                    
<li>
    <a href="../../actions-doc/hls_helloworld_1024/" class="dropdown-item">hls_helloworld_1024</a>
</li>
                                    
<li>
    <a href="../../actions-doc/hls_hbm_memcopy_512/" class="dropdown-item">hls_hbm_memcopy_512</a>
</li>
                                    
<li>
    <a href="../../actions-doc/hls_hbm_memcopy_1024/" class="dropdown-item">hls_hbm_memcopy_1024</a>
</li>
                                    
<li>
    <a href="../../actions-doc/hls_image_filter/" class="dropdown-item">hls_image_filter</a>
</li>
                                    
<li>
    <a href="../../actions-doc/hls_helloworld_python/" class="dropdown-item">hls_helloworld_python</a>
</li>
                                    
<li>
    <a href="../../actions-doc/hls_decimal_mult/" class="dropdown-item">hls_decimal_mult</a>
</li>
                                    
<li>
    <a href="../../actions-doc/hls_udp_512/" class="dropdown-item">hls_udp_512</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Deep Dive <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../deep-dive/software-api/" class="dropdown-item">Software API</a>
</li>
                                    
<li>
    <a href="../../deep-dive/registers/" class="dropdown-item">Registers</a>
</li>
                                    
<li>
    <a href="../../deep-dive/hardware-logic/" class="dropdown-item">Hardware Logic</a>
</li>
                                    
<li>
    <a href="../../deep-dive/board-package/" class="dropdown-item">New Board Support</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Appl. Notes <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../setup_power_tools/" class="dropdown-item">Setup Power Tools</a>
</li>
                                    
<li>
    <a href="../ofc_debug/" class="dropdown-item">Debug Tool</a>
</li>
                                    
<li>
    <a href="../Installing_an_OC-AD9V3_on_AC922/" class="dropdown-item">OC-AD9V3 installation in AC922</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active">OC-AD9H7 installation in IC922</a>
</li>
                                    
<li>
    <a href="../How_Data_is_Managed/" class="dropdown-item">How Data is Managed in OC-ACCEL</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Misc <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../misc/doc-guide/" class="dropdown-item">Document Guide</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../Installing_an_OC-AD9V3_on_AC922/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../How_Data_is_Managed/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="https://github.com/OpenCAPI/oc-accel-doc" class="nav-link"><i class="fa fa-github"></i> GitHub</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#application-note-opencapi-quickstart-installing-an-oc-ad9h7-on-ic922" class="nav-link">Application Note : OpenCAPI Quickstart Installing an OC-AD9H7 on IC922</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#foreword" class="nav-link">Foreword</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#ic922-hardware-setup" class="nav-link">IC922 Hardware Setup</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#oc-ad9h7-board-setup" class="nav-link">OC-AD9H7 board Setup</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#setup-tools-on-the-power-server-environment" class="nav-link">Setup tools on the POWER server environment</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#check-that-the-cards-are-recognized-as-accelerators" class="nav-link">Check that the cards are recognized as accelerators</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#first-programming-of-a-brand-new-oc-9h7-card-no-capi-image-was-ever-installed" class="nav-link">First programming of a brand new OC-9H7 card (no CAPI image was ever installed)</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#standard-programming-of-an-oc-9h7-card-oc-image-already-in-it" class="nav-link">Standard programming of an OC-9H7 card (OC image already in it)</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#running-the-test-image-if-card-has-been-already-programmed-with-a-oc-image" class="nav-link">Running the Test Image if card has been already programmed with a OC image</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="application-note-opencapi-quickstart-installing-an-oc-ad9h7-on-ic922">Application Note : OpenCAPI Quickstart Installing an OC-AD9H7 on IC922</h1>
<p>OpenCAPI QuickStart OC-AD9H7 on IC922</p>
<p>By IBM Systems Group
January 2021</p>
<p>Authors : OpenCAPI Support Team - Montpellier, FRANCE</p>
<h2 id="foreword">Foreword</h2>
<p>We will use <em>SNAP</em> word from time to time when mentionning the framework used with the previous versions of CAPI1.0 &amp; CAPI2.0 technologies.</p>
<p>Since OpenCAPI (sometimes called CAPI3.0) is the 3rd generation of CAPI, some former SNAP names can be found. Most of them have been changed though (eg <em>snap_maint</em> became <em>oc_maint</em>).</p>
<p>The supplier reference is ADM-PCIE-9H7, we will use OC-AD9H7 in OC-ACCEL.</p>
<h2 id="ic922-hardware-setup">IC922 Hardware Setup</h2>
<p>Unlike CAPI2.0, OpenCAPI (OC) doesn’t use PCI links, however, the card requires PCIe power supply and mechanical socket to work.
An OC card can thus be theoretically installed in any PCIe socket.
As the OC card can also be used in CAPI2 mode, Figure 1 indicates the slots where is can be placed for CAPI2/OpenCAPI dual usage. </p>
<p>Note that since OC-AD9H7 is 3/4 height it can only be placed in slots 4 and 9 using:</p>
<ul>
<li>
<p>either a special Wistron riser</p>
</li>
<li>
<p>or a mechanically modified original riser.</p>
</li>
</ul>
<div class="admonition warning">
<p class="admonition-title">NOTES</p>
<p>OC-AD9H7 is not yet directly orderable with an IC922. Specific risers need to be used
to host the card.</p>
</div>
<p><img alt="" src="../IC922_9h7_slots.png" /></p>
<p>Figure 1. Rear view of a IC922 system with PCIe CAPI enabled slots indicated</p>
<p>Please check details at:</p>
<p>https://www.ibm.com/support/knowledgecenter/en/9183-22X/p9iaf/p9iaf_pcie_slot_details.htm</p>
<h2 id="oc-ad9h7-board-setup">OC-AD9H7 board Setup</h2>
<p>The OC-AD9H7 has an octuple DIP switch SW1, located on the rear side of the board. Check that all switches are configured to default settings (all "OFF"), but SW1-6 at "ON". We don’t use these VPD data in SNAP/OC.</p>
<p>At the time of writing, only one OpenCAPI link can be configured with oc-accel. So please only connect CAPI_0 connector only.</p>
<p><img alt="AD-9H7_OC" src="../AD-9H7_OC.png" /></p>
<p>Information come from Alphadata web site:</p>
<ul>
<li><a href="https://www.alpha-data.com/dcp/products.php?product=adm-pcie-9h7">https://www.alpha-data.com/dcp/products.php?product=adm-pcie-9h7</a></li>
<li><a href="https://www.alpha-data.com/pdfs/adm-pcie-9h7%20user%20manual_v1_3.pdf">https://www.alpha-data.com/pdfs/adm-pcie-9h7%20user%20manual_v1_3.pdf</a></li>
</ul>
<h2 id="setup-tools-on-the-power-server-environment">Setup tools on the POWER server environment</h2>
<p>A general procedure is available <a href="../setup_power_tools/">here</a></p>
<h2 id="check-that-the-cards-are-recognized-as-accelerators">Check that the cards are recognized as accelerators</h2>
<p>Check that the cards are recognized by the Firmware and the OS</p>
<pre><code>lspci|grep accel
0006:00:00.0 Processing accelerators: IBM Device 062b
0006:00:00.1 Processing accelerators: IBM Device 062b
</code></pre>

<p>In this example, for this card, physical port is 0 and virtual port is 6.
If no card is found with this command, then your OC-9H7 card may not have a OpenCAPI image in it, or your firmware is too old.</p>
<p>Here is an example of 2 cards used in a P9 server one being recognized as CAPI2 the other as OC :</p>
<pre><code>lspci|grep acc
0006:00:00.0 Processing accelerators: IBM Device 062b    #OC
0006:00:00.1 Processing accelerators: IBM Device 062b
0008:00:00.0 Processing accelerators: IBM Device 0632 (rev 01) #CAPI2
0030:01:00.0 Processing accelerators: IBM Device 0477 (rev 02)
</code></pre>

<h2 id="first-programming-of-a-brand-new-oc-9h7-card-no-capi-image-was-ever-installed">First programming of a brand new OC-9H7 card (no CAPI image was ever installed)</h2>
<p>There are several ways to program a OC-AD9H7 card. If no CAPI image was ever installed on this board, then you’ll need to follow these following instructions to set it once. Then you’ll be able to go faster using the next paragraph.</p>
<p>A basic test image for the OC-9H7 card’s FPGA can be obtained from IBM Box. Programming this image onto the card will require Xilinx Vivado version 2018.1 or newer and a usb cable. To do so, access the device from Vivado’s hardware manager and follow these steps:</p>
<p>Right click on the "xcvu37p_0" entry in the device list and select "add configuration memory device".</p>
<p>Select "mt25qu01g-spi-x1_x2_x4_x8" from the list of config mem devices.</p>
<p>When prompted, choose to program the config mem device.</p>
<p>In the subsequent menu, select the two .mcs files, followed by the two optional .prm files.</p>
<p>The programming should complete in a few minutes. Note that the card needs to be power cycled (i.e. by rebooting the system) before the new image will take effect. On some servers the fast reboot service is operational, a complete power cycle is necessary to make sure the card powers off.</p>
<h2 id="standard-programming-of-an-oc-9h7-card-oc-image-already-in-it">Standard programming of an OC-9H7 card (OC image already in it)</h2>
<p>Images for the OC-AD9H7 card’s FPGA will be created from the OC-ACCEL environment and will be placed in  </p>
<pre><code>~/oc-accel/hardware/build/Images
</code></pre>

<p>Once successfully synthesized. Then using the FPGA Image loader, you will program and reset the FPGA with your binary files using the following command:</p>
<pre><code>sudo oc-flash-script oc_my_user_image.bin
</code></pre>

<p>Depending on the format of the FPGA board Flash devices, you may need 1or 2 binary files. OC-AD9H7 card needs 2 binary files noted as primary and secondary. You will so call the loader with the 2 files in the following order:</p>
<pre><code>sudo oc-flash-script oc_my_user_image_primary.bin oc_my_user_image_secondary.bin
</code></pre>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>At the time of writing oc-utils doesn't support online programming of OC-AD9H7 yet.</p>
</div>
<p>JTAG programming is required.</p>
<h2 id="running-the-test-image-if-card-has-been-already-programmed-with-a-oc-image">Running the Test Image if card has been already programmed with a OC image</h2>
<p>From the oc-accel directory, compile once the software and applications</p>
<pre><code>cd oc-accel
git pull   # in case you already cloned earlier and want to stay up to date
make software apps
</code></pre>

<p>The default test which has been compiled in the Box’s image is a hls_hbm_memcopy1024 example.</p>
<pre><code>oc_find_card -v -A ALL    #This should return the card position
OC-AD9H7 card has been detected in card position: 4
...
</code></pre>

<p>then let OC-ACCEL framework discover the cards and actions with the oc_maint command.</p>
<p>Mention the card slot number if different from 0 using -C option. </p>
<p>This command needs to be run almost once after a reset and will return the action stated here as “HLS HBM Memcopy” (1024b)"</p>
<pre><code>~/oc-accel/software/tools/oc_maint -v [-C4]
</code></pre>

<p>You can now:</p>
<ul>
<li>Either run the memcopy program doing any transfer you want. </li>
</ul>
<p>You will get the explanations on how to use this example by typing</p>
<pre><code>~/oc-accel/actions/hls_hbm_memcopy_1024/sw/snap_hbm_memcopy
</code></pre>

<ul>
<li>or run automatic test of hls_hbm_memcopy_1024 using</li>
</ul>
<pre><code>~/oc-accel/actions/hls_hbm_memcopy_1024/tests/hw_throughput_test.sh -d INCR
</code></pre>

<p>which will give you the bandwidth measured between FPGA, host memory and on-board for different file size exchanged.</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../extra.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
