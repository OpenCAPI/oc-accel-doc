<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>(5) HLS C++ design - OC-Accel Doc</title>
        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
        <link href="../../extra.css" rel="stylesheet">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap-3.0.3.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container">

                <!-- Collapsed navigation -->
                <div class="navbar-header">
                    <!-- Expander button -->
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="../..">OC-Accel Doc</a>
                </div>

                <!-- Expanded navigation -->
                <div class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">About <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../..">Overview</a>
</li>
                                    
<li >
    <a href="../../repository/">About the repository</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">User Guide <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../0-steps/">(0) Steps in a glance</a>
</li>
                                    
<li >
    <a href="../1-prepare-env/">(1) Prepare environment</a>
</li>
                                    
<li >
    <a href="../2-run-helloworld/">(2) Run helloworld</a>
</li>
                                    
<li >
    <a href="../3-new-action/">(3) Create a new action</a>
</li>
                                    
<li >
    <a href="../4-hdl-design/">(4) Verilog/VHDL design</a>
</li>
                                    
<li class="active">
    <a href="./">(5) HLS C++ design</a>
</li>
                                    
<li >
    <a href="../6-co-simulation/">(6) Co-Simulation</a>
</li>
                                    
<li >
    <a href="../7-build-image/">(7) Build image</a>
</li>
                                    
<li >
    <a href="../8-deploy/">(8) Deploy on Power Server</a>
</li>
                                    
<li >
    <a href="../9-migrate/">(9) Migrate from SNAP1/2</a>
</li>
                                    
<li >
    <a href="../10-tips/">(10) Tips</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Examples <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../actions-doc/hdl_example/">hdl_example</a>
</li>
                                    
<li >
    <a href="../../actions-doc/hdl_single_engine/">hdl_single_engine</a>
</li>
                                    
<li >
    <a href="../../actions-doc/hls_helloworld/">hls_helloworld</a>
</li>
                                    
<li >
    <a href="../../actions-doc/hls_memcopy_1024/">hls_memcopy_1024</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Deep Dive <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../deep-dive/software-api/">Software API</a>
</li>
                                    
<li >
    <a href="../../deep-dive/registers/">Registers</a>
</li>
                                    
<li >
    <a href="../../deep-dive/hardware-logic/">Hardware Logic</a>
</li>
                                    
<li >
    <a href="../../deep-dive/board-package/">New Board Support</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Misc <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../misc/doc-guide/">Document Guide</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li >
                                <a rel="next" href="../4-hdl-design/">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li >
                                <a rel="prev" href="../6-co-simulation/">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li>
                                <a href="https://github.com/OpenCAPI/oc-accel"><i class="fa fa-github"></i> GitHub</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#hls-action-hw-design">HLS Action HW Design</a></li>
            <li><a href="#hls_action">hls_action()</a></li>
            <li><a href="#din_gmem-and-dout_gmem">din_gmem and dout_gmem</a></li>
            <li><a href="#d_ddrmem">d_ddrmem</a></li>
            <li><a href="#axi-lite-registers">AXI Lite Registers</a></li>
            <li><a href="#hls-optimization">HLS optimization</a></li>
        <li class="main "><a href="#hls-action-sw-design">HLS Action SW Design</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="hls-action-hw-design">HLS Action HW Design</h1>
<p>Take hls_memcopy_1024 as an example, the top design is <code>hardware/hdl/hls/action_wrapper.vhd_source</code> but the HLS developer doesn't need to modify it. That is a common wrapper. </p>
<h2 id="hls_action">hls_action()</h2>
<p>HLS developer needs to modify <code>$ACTION_ROOT/hw/xxx.CPP</code>, starting from <code>hls_action()</code>:</p>
<pre><code>//--- TOP LEVEL MODULE -------------------------------------------------
void hls_action(snap_membus_1024_t *din_gmem,
        snap_membus_1024_t *dout_gmem,
        snap_membus_512_t *d_ddrmem,
        action_reg *act_reg,
        action_RO_config_reg *Action_Config)
{
    // Host Memory AXI Interface
#pragma HLS INTERFACE m_axi port=din_gmem bundle=host_mem offset=slave depth=512  \
  max_read_burst_length=64  max_write_burst_length=64 
#pragma HLS INTERFACE s_axilite port=din_gmem bundle=ctrl_reg offset=0x030

#pragma HLS INTERFACE m_axi port=dout_gmem bundle=host_mem offset=slave depth=512 \
  max_read_burst_length=64  max_write_burst_length=64 
#pragma HLS INTERFACE s_axilite port=dout_gmem bundle=ctrl_reg offset=0x040

    // DDR memory Interface
#pragma HLS INTERFACE m_axi port=d_ddrmem bundle=card_mem0 offset=slave depth=512 \
  max_read_burst_length=64  max_write_burst_length=64 
#pragma HLS INTERFACE s_axilite port=d_ddrmem bundle=ctrl_reg offset=0x050

    // Host Memory AXI Lite Interface
#pragma HLS DATA_PACK variable=Action_Config
#pragma HLS INTERFACE s_axilite port=Action_Config bundle=ctrl_reg offset=0x010
#pragma HLS DATA_PACK variable=act_reg
#pragma HLS INTERFACE s_axilite port=act_reg bundle=ctrl_reg offset=0x100
#pragma HLS INTERFACE s_axilite port=return bundle=ctrl_reg

...
</code></pre>

<p>In Vivado High Level Synthesis, the above C code can be synthesized to have:</p>
<ul>
<li>
<p>Host Memory AXI Interface</p>
<ul>
<li>din_gmem</li>
<li>dout_gmem</li>
</ul>
</li>
<li>
<p>DDR memory Interface</p>
<ul>
<li>d_ddrmem</li>
</ul>
</li>
<li>
<p>AXI Lite Interface</p>
<ul>
<li>Action_Config at offset 0x10</li>
<li>act_reg at offset 0x100</li>
</ul>
</li>
</ul>
<h2 id="din_gmem-and-dout_gmem">din_gmem and dout_gmem</h2>
<p>They represent the whole <code>2^64</code> Host memory space. But this memory space is shaped as a <strong>128Bytes width</strong>, <strong>(2^64/128) depth</strong> array. With CAPI/OpenCAPI, the action hardware can directly use EA (effective address, the same pointer in software) to access host memory. </p>
<p>You will see this shape from the definition of "snap_membus_1024_t".</p>
<pre><code>snap_membus_1024_t *din_gmem,
snap_membus_1024_t *dout_gmem,
</code></pre>

<p>Because din_gmem and dout_gmem are shaped as 128B width, the EA address needs to be right-shifted by <code>log2(128) = 7</code> before being used as din_gmem/dout_gmem's array index. </p>
<pre><code>// byte address received need to be aligned with port width
InputIndex = (act_reg-&gt;Data.in.addr)   &gt;&gt; ADDR_RIGHT_SHIFT_1024;
OutputIndex = (act_reg-&gt;Data.out.addr) &gt;&gt; ADDR_RIGHT_SHIFT_1024;
</code></pre>

<p>Then you can use <code>memcpy()</code> or <code>data = din_gmem[index]</code> or <code>dout_gmem[index] = data</code> to use them.</p>
<ul>
<li>din_gmem is for reading data from Host.</li>
<li>dout_gmem is for writing data to Host.</li>
</ul>
<p>They should be able to be combined just like <strong>d_ddrmem</strong> but we want to keep the same style as SNAP1/2 for now.</p>
<h2 id="d_ddrmem">d_ddrmem</h2>
<p>It represents one channel of DDR on FPGA board. In SNAP1/2 and OC-Accel, only one channel (one DDR memory controller) is implemented as an example. </p>
<p>However, usually the FPGA board provides more than one DDR channel. There are multiple ways to arrange them so it's user-case dependent. </p>
<p>Some FPGA boards have HBM. The developer can enable it similarly like DDR, which is introduced in <a href="../../deep-dive/board-package/">Deep Dive: New board support</a>.</p>
<p>Please be aware of the address range you can use for a single DDR channel. d_ddrmem is shaped as a <strong>64Bytes width</strong>, <strong>(Capacity/64)</strong> depth array. Exceeding the available DDR address range will lead to an unknown error.</p>
<h2 id="axi-lite-registers">AXI Lite Registers</h2>
<ul>
<li>
<p>The first 16bytes <strong>(0x00 to 0x0F)</strong> are pre-defined by <code>software/include/osnap_hls_if.h</code>, the user is not supposed to change that. It controls the <strong>start</strong>, <strong>stop</strong> and <strong>interrupt</strong> of the HLS Action.</p>
</li>
<li>
<p>The following 8bytes <strong>(0x10 to 0x17)</strong> is action_RO_config_reg (Action_Config), defined in <code>actions/include/hls_snap*.H</code>, the user should set <strong>action_type</strong> and <strong>release_level</strong> information in above two fields.</p>
</li>
</ul>
<pre><code>typedef struct {
        snapu32_t action_type;   // 4 bytes
        snapu32_t release_level; // 4 bytes
} action_RO_config_reg;
</code></pre>

<ul>
<li>The action_reg has 128bytes <strong>(0x100 to 0x180)</strong>, composed of two segments <strong>Control</strong> and <strong>job Data</strong>, defined in <code>$ACTION_ROOT/hw/*.H</code></li>
</ul>
<pre><code>typedef struct {
    CONTROL Control;    /*  16 bytes */
    memcopy_job_t Data; /* up to 108 bytes */
    uint8_t padding[SNAP_HLS_JOBSIZE - sizeof(memcopy_job_t)];
} action_reg;
</code></pre>

<ul>
<li>Struct CONTROL is also defined in <code>actions/include/hls_snap*.H</code>, it defines the <strong>flags</strong> and <strong>return code</strong>.</li>
</ul>
<pre><code>typedef struct {
        snapu8_t sat;
        snapu8_t flags;
        snapu16_t seq;
        snapu32_t Retc;
        snapu64_t Reserved;
} CONTROL;
</code></pre>

<ul>
<li>At last, what the developer can really freely define is just <strong>job Data</strong>: </li>
</ul>
<pre><code>memcopy_job_t Data; /* up to 108 bytes */
</code></pre>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If 108 bytes are not enough, please define a small buffer in Host memory as <strong>WED buffer</strong> (Work Element Descriptor), store all of the parameters in this WED buffer, and just put the address pointers of this WED buffer into <code>xxxx_job_t</code>. Ask HLS Action to read the content of WED buffer first, then do the following jobs.</p>
</div>
<p>The above register layout is also drawn in <a href="../../deep-dive/registers/#action-register-definition">Deep Dive: Registers</a> </p>
<h2 id="hls-optimization">HLS optimization</h2>
<p>Xilinx Document <a href="https://www.xilinx.com/support/documentation/sw_manuals/xilinx2019_1/ug902-vivado-high-level-synthesis.pdf">UG902: Vivado High-Level Synthesis</a> is an important guide book to understand how to add "directives" to your HLS C/C++ code.</p>
<p>You can also refer to SNAP1/2 document <a href="https://github.com/open-power/snap/blob/master/doc/AN_CAPI_SNAP-How_to_optimize_an_HLS_action.pdf">How to Optimize HLS Action</a> to learn how to run standalone testing before OCSE Co-simulation, and how to fully explore UNROLL and PIPELINE directives in HLS. </p>
<h1 id="hls-action-sw-design">HLS Action SW Design</h1>
<p>The steps include:</p>
<ul>
<li>snap_card_alloc_dev()</li>
<li>snap_attach_action()</li>
<li><strong>Prepare job</strong>: snap_set_job()</li>
<li><strong>Main body</strong>: snap_action_sync_execute_job(), which has three steps:<ul>
<li>snap_action_sync_execute_job_set_regs (action, cjob); //Set action_reg by MMIO</li>
<li>snap_action_start(action);</li>
<li>snap_action_sync_execute_job_check_completion (action, cjob, timeout_sec);</li>
</ul>
</li>
<li><strong>Check Return code</strong>: <code>cjob.retc</code></li>
<li>snap_detach_action()</li>
<li>snap_card_free()</li>
</ul></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../extra.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
